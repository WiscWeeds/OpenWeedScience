---
date: "2019-12-10"
math: "true"
title: ONE-WAY ANOVA OF WEED CONTROL DATA
---

```{r include=FALSE}
library(tidyverse)
library(glmmTMB)
library(lme4)
library(lmerTest)
library(emmeans)
library(RCurl)
library(kableExtra)
library(car)
```

By Maxwel Coura Oliveira and Rodrigo Werle

The weed control is likely the most common experiments and data analysis performed in the weed research discipline. In general, the goal is to investigate herbicides that promote the best weed control of target weed(s). Experiments is usually organized in a one-way randomized complete block design with multiple treatments (herbicides). At 21 (researcher choice) days after treatment (DAT), a percent (%) control rate is given to weed(s). The weed control rate varies from 0% (uninjured plants) and 100% (complete dead plants). Therefore, before setting up the experiments, the researcher know that the results will range from 0 to 100%. 

This is nonparametric statistics, which does not follow a normal (gaussean) distribution. Normal distribution is a assumption of the ANOVA. We will use the *beta distribution* (logit scale), which is a family of continuous probability distributions defined on the interval [0, 1]. The weed control rates should be mutate to the interval 0 and 1. For example, if the weed control of Palmer amaranth is 90%, it should be listed as 0.90 in your excel spreadsheet file. Also, *beta distribution* will not accept 0 and 1 values. Thus, weed control of 0% and 100% must be changed to 0.01 and 0.99, respectively. 

# Getting started

- Download **R** for your laptop system from: https://www.r-project.org

- Download **RStudio** for your laptop system from: https://rstudio.com

## Create a R Project file

- Click in File -> New project... -> New directory -> New Project -> Save the R work directory anywhere you want in your laptop. 

The saved file will have a R project and you should copy and paste all your raw data (excel file) in the same work directory.

- Click in File -> New File -> R script (.R)

or

- Click in File -> New File -> R markdown... (.Rmd)

Althouth I like working on R markdown, R script is easier to work in R studio but R markdown has more advantages. 

## Install packages

Copy and paste the following codes in your R script or R markdown. 

```
install.packages(tidyverse)
install.packages(glmmTMB)
install.packages(lme4)
install.packages(lmerTest)
install.packages(emmeans)
install.packages(RCurl)
install.packages(car)
install.packages(kableExtra)
```

Run all codes below by clicking in the Run option in the top right corner of you R script or R markdown. These codes will install the necessary packages for analyzing weed control (%) experiments. Once you install these packages you will not need to install them every time you work in Rstudio, unless you update R or Rstudio.


## Data


```
library(tidyverse)
library(RCurl)
```

The data used for the exercise is from a published [manuscript](https://www.doi.org/10.1017/wet.2016.4) of a waterhemp (*Amaranthus tuberculatus*) biotype control (%) with postemergence herbicides. Here for the exercise, herbicides are named A, B, C, D, and E. Run the following codes below to load the data into R.


```{r}
df_path <- getURL("https://raw.githubusercontent.com/maxwelco/Anova-beta/master/data/control.csv")

control <- read_csv(df_path)
```

After run the codes above, the data should be in the *control*.

```{r}
control
```

The data have year (2013 and 2014), herbicide (A, B, C, D, E), rep (1, 2 ,3), and control of waterhemp (proportions).


# Bartlett Test Of Homogeneity Of Variances

Performs Bartlett's test of the null that the variances in each of the year are the same.

> bartlett.test function

```{r}
bartlett.test(control ~ year, data=control)
```


Results shows p-value = 0.987, the null hypothesis is accepted, meaning that variances in each year are the same.


## Model

- Run the packages below

```
library(glmmTMB)
library(lme4)
library(lmerTest)
```

- Generalized Linear Mixed Models using Template Model Builder by Mollie Brooks

- Beta family with logit

- Mixed model

The model has control as a response variable, herbicide as fixed effects, and year (nested with rep) as random effects.

> glmmTMB function

```{r}
model <- glmmTMB(control ~ herbicide + (1|year/rep), beta_family(link = "logit"), data=control)
```


##  Anova


- Run the package below

```
library(car)
```

> *Anova* function or *Anova.glmmTMB* function

```{r}
Anova(model)
```

The *P*-value < 2.2e-16; there is a lower evidence that a difference of some magnitude between herbicides tested could occur by chance alone assuming null hypothesis is true.



## Cheking the herbicide control on waterhemp 

- Run the package below

```
library(emmeans)
```


#### Interaction-Style Plots For Estimated Marginal Means (emmip)

- type="response", herbicide and intervals back from the logit scale

- coord_flip(), inverted the axis (better visualization)

> *emmip* function

```{r}
emmip(model, ~herbicide, type="response") + coord_flip()
```

This figure helps to visualize the herbicide effect on waterhemp control. It is useful in treatments arranged in factorial design.

#### Estimated Marginal Means (Least-Squares Means)

- type="response", herbicide and intervals back from the logit scale

- cont="pairwise", comparisons between each herbicide treatments

- adjust="none", fisher's least significant difference (try tukey)

The lsmeans provided the weed control (prop), SE (standard error) and confidence intervals (lower.CL and upper.CL). Moreover, lsmeans provides the pairwise contrasts between treatments (herbicides).

> *emmeans* function

```{r}
lsmeans <- emmeans(model, ~ herbicide, cont="pairwise", adjust="none", type="response", alpha=0.05)

lsmeans
```


#### PLOT LSMEANS

- comparisons=TRUE, comparisons between treatments with red arrows

- type="response", herbicide and intervals back from the logit scale

- alpha=0.05, significance level to use in constructing comparison arrows

- adjust="none", Fisher's least significant difference (try tukey)

> *plot* function

```{r}
plot(lsmeans, ~ herbicide, comparisons=TRUE, type="response", alpha=0.05, adjust="none")
```

The black dot is the mean of herbicide waterhemp control and purple is the confidence intervals. Red arrow is a comparison amongst treatments, if a red arrow do not overlap, treatments are different. See contrasts from lsmeans to double check. 


## Extract And Display Information On All Pairwise Comparisons Of Estimated Marginal Means

- alpha=0.05, numeric value giving the significance level for the comparisons

- Letters=letters, display letter grouping treatments according to pairwise comparisons

- adjust="none", fisher's least significant difference (try tukey)

- reversed = TRUE, the order of use of the letters is reversed

> *CLD* function

```{r warning=FALSE}
cld <-CLD(lsmeans, alpha=0.05, Letters=letters, adjust="none", reversed = TRUE)

cld 
```


###### Warning
```
"The CLD function and methods are deprecated. Compact-letter displays (CLDs) encourage a misleading interpretation of significance testing by visually grouping means whose comparisons have P > alpha as though they are equal. However, failing to prove two means are different does not prove that they are the same. In addition, CLDs make a hard distinction between P values nearly equal to alpha but on opposite sides."
```



## Figure 

##### Dot plot with confidence intervals 

Since *CLD* function is deprecated, I recommend use the lsmeans to create a figure.

```{r}
nd <- as.data.frame(lsmeans$emmeans)
```

Use *nd* to plot a figure.

> ggplot function



```{r}
ggplot(nd, aes(x=herbicide, y=prop*100, color=herbicide)) + 
  geom_point(size=4) + ylim(0,100) +
  scale_color_manual(values=c("red", "blue", "green", "orange", "purple")) +
  theme_bw() +  labs(y="Waterhemp control (%)", x="Herbicides") +
  geom_linerange(aes(ymin  =  lower.CL*100, ymax  =  upper.CL*100), size=1.5) + 
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=15),
        legend.position = "none") 
```

The mean and confidence intervals of each herbicide are displayed in a *ggplot* figure.



##### Bar plot with letters


If you like presenting barplots with letters. Here is how you should proceed.

```{r warning=FALSE}
ggplot(cld, aes(x=herbicide, y=prop*100, fill=herbicide, label=.group)) + 
  geom_bar(stat="identity") + ylim(0,105) +
  scale_fill_manual(values=c("red", "blue", "green", "orange", "purple")) +
  theme_bw() +  labs(y="Waterhemp control (%)", x="Herbicides") +
  geom_text(nudge_y = 7, size=8) + 
  theme(axis.title = element_text(size=16),
        axis.text = element_text(size=15),
        legend.position = "none") 
```

## Table

- Run the package below

```
library(kableExtra)
```

This is a very simple table generator.

> *kable* function

```{r}
kable(nd)
```













